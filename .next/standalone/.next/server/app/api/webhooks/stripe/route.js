"use strict";(()=>{var e={};e.id=798,e.ids=[798],e.modules={53524:e=>{e.exports=require("@prisma/client")},67096:e=>{e.exports=require("bcrypt")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},9962:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>w,patchFetch:()=>g,requestAsyncStorage:()=>f,routeModule:()=>p,serverHooks:()=>h,staticGenerationAsyncStorage:()=>v});var s={};t.r(s),t.d(s,{POST:()=>u});var a=t(49303),i=t(88716),n=t(60670),o=t(71615),d=t(87070),c=t(69206),l=t(88658);async function u(e){try{if(!c.A)return d.NextResponse.json({message:"Stripe is not configured",ok:!1},{status:500});let r=await e.text(),t=(0,o.headers)().get("stripe-signature");if(!t)return new Response("Invalid signature",{status:400});let s=c.A.webhooks.constructEvent(r,t,process.env.STRIPE_WEBHOOK_SECRET);if("checkout.session.completed"===s.type){if(!s.data.object.customer_details?.email)throw Error("Missing user email");let{listingId:e,startDate:r,endDate:t,totalPrice:a,userId:i}=s.data.object.metadata||{};if(!e||!r||!t||!a||!i)throw Error("Invalid request metadata");await (0,l.createReservation)({listingId:e,startDate:new Date(r),endDate:new Date(t),totalPrice:Number(a),userId:i})}return d.NextResponse.json({result:s,ok:!0})}catch(e){return console.error(e),d.NextResponse.json({message:"Something went wrong",ok:!1},{status:500})}}let p=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/webhooks/stripe/route",pathname:"/api/webhooks/stripe",filename:"route",bundlePath:"app/api/webhooks/stripe/route"},resolvedPagePath:"/home/oussasz/Project/Dz Dari/lugario/app/api/webhooks/stripe/route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:f,staticGenerationAsyncStorage:v,serverHooks:h}=p,w="/api/webhooks/stripe/route";function g(){return(0,n.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:v})}},90455:(e,r,t)=>{t.d(r,{L:()=>l});var s=t(67096),a=t.n(s),i=t(13539),n=t(53797),o=t(77234),d=t(77210),c=t(9487);let l={adapter:(0,i.N)(c.db),providers:[(0,d.Z)({clientId:process.env.GITHUB_CLIENT_ID,clientSecret:process.env.GITHUB_CLIENT_SECRET}),(0,o.Z)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET}),(0,n.Z)({name:"credentials",credentials:{email:{label:"email",type:"text"},password:{label:"password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)throw Error("Invalid credentials");let r=await c.db.user.findUnique({where:{email:e.email}});if(!r||!r?.password||!await a().compare(e.password,r.password))throw Error("Invalid credentials");return r}})],callbacks:{session:async({token:e,session:r})=>(e&&(r.user.id=e.id,r.user.name=e.name,r.user.email=e.email),r),jwt:async({token:e,user:r})=>r?{...e,...r}:e},pages:{signIn:"/"},session:{strategy:"jwt"},secret:process.env.NEXTAUTH_SECRET}},9487:(e,r,t)=>{t.d(r,{db:()=>a});var s=t(53524);let a=globalThis.prisma||new s.PrismaClient},69206:(e,r,t)=>{t.d(r,{A:()=>i});var s=t(82604);let a=process.env.STRIPE_API_KEY,i=a?new s.Z(a,{apiVersion:"2024-09-30.acacia",typescript:!0}):null},97049:(e,r,t)=>{e.exports=t(23191).vendored["react-rsc"].ReactDOM},51749:(e,r,t)=>{e.exports=t(23191).vendored["react-rsc"].ReactServerDOMWebpackServerEdge},88658:(e,r,t)=>{t.r(r),t.d(r,{$$ACTION_0:()=>u,$$ACTION_1:()=>f,$$ACTION_2:()=>h,$$ACTION_3:()=>g,createPaymentSession:()=>w,createReservation:()=>p,deleteReservation:()=>v,getReservations:()=>l});var s=t(24330);t(60166);var a=t(57708),i=t(9487),n=t(67738),o=t(84848),d=t(69206),c=t(40618);let l=(0,s.j)("31b04723e7c53cd1acbec67b730e7d0abc16a5f7",u);async function u(e){try{let{listingId:r,userId:t,authorId:s,cursor:a}=e,o={};t&&(o.userId=t),r&&(o.listingId=r),s&&(o.listing={userId:s});let d={where:o,take:n.UM,include:{listing:!0},orderBy:{createdAt:"desc"}};a&&(d.cursor={id:a},d.skip=1);let c=await i.db.reservation.findMany({...d}),l=c.length===n.UM?c[n.UM-1].id:null;return{listings:c.map(e=>{let{id:r,startDate:t,endDate:s,totalPrice:a,listing:i}=e;return{...i,reservation:{id:r,startDate:t,endDate:s,totalPrice:a}}}),nextCursor:l}}catch(e){return console.log(e?.message),{listings:[],nextCursor:null}}}let p=(0,s.j)("33f115557067f48ceee4a50b443aa423758b731d",f);async function f({listingId:e,startDate:r,endDate:t,totalPrice:s,userId:n}){try{if(!e||!r||!t||!s)throw Error("Invalid data");await i.db.listing.update({where:{id:e},data:{reservations:{create:{userId:n,startDate:r,endDate:t,totalPrice:s}}}}),(0,a.revalidatePath)(`/listings/${e}`)}catch(e){throw Error(e?.message)}}let v=(0,s.j)("3e9103be237aebf085f90f3c7858dad7d4c215ad",h);async function h(e){try{let r=await (0,o.t)();if(!r)throw Error("Unauthorized");if(!e||"string"!=typeof e)throw Error("Invalid ID");let t=await i.db.reservation.findUnique({where:{id:e}});if(!t)throw Error("Reservation not found!");return await i.db.reservation.deleteMany({where:{id:e,OR:[{userId:r.id},{listing:{userId:r.id}}]}}),(0,a.revalidatePath)("/reservations"),(0,a.revalidatePath)(`/listings/${t.listingId}`),(0,a.revalidatePath)("/trips"),t}catch(e){throw Error(e.message)}}let w=(0,s.j)("0ad09d62211ecf130a12e0b1fb6dd072ad373b1e",g);async function g({listingId:e,startDate:r,endDate:t,totalPrice:s}){if(!e||!r||!t||!s)throw Error("Invalid data");let a=await i.db.listing.findUnique({where:{id:e}});if(!a)throw Error("Listing not found!");let n=await (0,o.t)();if(!n)throw Error("Please log in to reserve!");let c=await d.A.products.create({name:"Listing",images:[a.imageSrc],default_price_data:{currency:"USD",unit_amount:100*s}});return{url:(await d.A.checkout.sessions.create({success_url:`${process.env.NEXT_PUBLIC_SERVER_URL}/trips`,cancel_url:`${process.env.NEXT_PUBLIC_SERVER_URL}/listings/${a.id}`,payment_method_types:["card"],mode:"payment",shipping_address_collection:{allowed_countries:["DE","US","NP","CH","BH","AU"]},metadata:{listingId:e,startDate:String(r),endDate:String(t),totalPrice:s,userId:n.id},line_items:[{price:c.default_price,quantity:1}]})).url}}(0,c.h)([l,p,v,w]),(0,s.j)("1106a624fc89780734d43596a1878891b0872f57",l),(0,s.j)("84b639be183e082fba4d06c9dff2f39883927b92",p),(0,s.j)("2ad9c02f7138be20aaff203fa989dbdd2c65d88f",v),(0,s.j)("578785c17f7947cb2d65472cb4242c57c8621203",w)},84848:(e,r,t)=>{t.d(r,{t:()=>i});var s=t(75571),a=t(90455);let i=async()=>{let e=await (0,s.getServerSession)(a.L);return e?.user}},67738:(e,r,t)=>{t.d(r,{UM:()=>i});var s=t(63759),a=t(43758);s.Paj,s.f$3,s.sHf,s.dKE,s.Yfi,s.KfF,s.Nzl,s.eAf,s.Yqy,s.jsv,s.I4E,s.rhR,s.vc9,a.Q7H,s.Ys1,s.IB_,s.bVG,s.yEz,s.XG1,s.eVG,s.WKE,s.h9I,s.fC4;let i=16}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[948,386,76,879,972,604],()=>t(9962));module.exports=s})();